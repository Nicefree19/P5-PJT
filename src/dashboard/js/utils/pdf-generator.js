/**
 * PDF Generator Module - WP-1-A Module Separation
 *
 * Pure functions for PDF report generation.
 * Extracted from index.html for bundle size optimization.
 *
 * @version 1.0.0
 * @since 2026-01-08
 */

/**
 * Calculate floor progress data
 * @param {Object} columns - Column data
 * @returns {Object} Progress data by floor
 */
function calculateFloorProgress(columns) {
    const floorIds = ['F01', 'F02', 'F03', 'F04', 'F05', 'F06', 'F07', 'F08', 'F09', 'F10', 'RF'];
    const progress = {};

    floorIds.forEach(floorId => {
        const floorColumns = Object.values(columns).filter(c =>
            c.floor === floorId || c.floorId === floorId
        );

        const total = floorColumns.length || 828;
        const completed = floorColumns.filter(c => c.status === 'installed').length;
        const active = floorColumns.filter(c => c.status === 'active').length;
        const hold = floorColumns.filter(c =>
            c.status === 'hold_tc' || c.status === 'hold_design'
        ).length;

        progress[floorId] = {
            total,
            completed,
            active,
            hold,
            progress: total > 0 ? ((completed / total) * 100).toFixed(1) : '0.0'
        };
    });

    return progress;
}

/**
 * Get severity label in Korean
 * @param {string} severity - Severity code
 * @returns {string} Korean label
 */
function getSeverityLabel(severity) {
    const labels = {
        'critical': '긴급',
        'high': '높음',
        'medium': '보통',
        'low': '낮음'
    };
    return labels[severity] || severity || '-';
}

/**
 * Get issue status label in Korean
 * @param {string} status - Status code
 * @returns {string} Korean label
 */
function getIssueStatusLabel(status) {
    const labels = {
        'open': '열림',
        'in_progress': '진행중',
        'resolved': '해결됨',
        'closed': '종료'
    };
    return labels[status] || status || '-';
}

/**
 * Add Cover Page to PDF
 * @param {Object} doc - jsPDF document
 * @param {string} timestamp - Generation timestamp
 * @param {string} reportType - Report type
 * @param {Object} data - { columns, issues, selectedFloor, selectedJeolju }
 */
function addPdfCoverPage(doc, timestamp, reportType, data) {
    const { columns, issues, selectedFloor, selectedJeolju } = data;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const centerX = pageWidth / 2;

    // Background header bar
    doc.setFillColor(31, 111, 235);
    doc.rect(0, 0, pageWidth, 60, 'F');

    // Project badge
    doc.setFillColor(35, 134, 54);
    doc.roundedRect(centerX - 30, 15, 60, 12, 3, 3, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10);
    doc.text('P5 FAB PROJECT', centerX, 23, { align: 'center' });

    // Main title
    doc.setFontSize(24);
    doc.setTextColor(255, 255, 255);
    doc.text('P5 복합동 구조 통합 관리', centerX, 45, { align: 'center' });

    // Subtitle with report type
    const reportTypeLabels = {
        'summary': '요약 보고서',
        'detailed': '상세 보고서',
        'issues': '이슈 보고서'
    };
    doc.setFontSize(16);
    doc.text(reportTypeLabels[reportType] || '요약 보고서', centerX, 55, { align: 'center' });

    // Project info section
    doc.setTextColor(100, 100, 100);
    doc.setFontSize(11);

    const infoY = 90;

    // Statistics summary
    const totalColumns = Object.keys(columns).length;
    const completedCount = Object.values(columns).filter(c => c.status === 'installed').length;
    const progressRate = totalColumns > 0 ? ((completedCount / totalColumns) * 100).toFixed(1) : 0;
    const openIssues = issues.filter(i => i.status === 'open' || i.status === 'in_progress').length;

    // Info box
    doc.setDrawColor(200, 200, 200);
    doc.setFillColor(248, 249, 250);
    doc.roundedRect(30, infoY - 5, pageWidth - 60, 55, 3, 3, 'FD');

    doc.setTextColor(60, 60, 60);
    doc.setFontSize(10);
    doc.text('프로젝트 정보', 40, infoY + 5);

    doc.setTextColor(100, 100, 100);
    doc.setFontSize(9);
    doc.text(`총 기둥 수: ${totalColumns.toLocaleString()}개 (11개 층 x 828개 기둥/층)`, 40, infoY + 15);
    doc.text(`전체 진행률: ${progressRate}%`, 40, infoY + 23);
    doc.text(`완료: ${completedCount.toLocaleString()}개 | 미해결 이슈: ${openIssues}건`, 40, infoY + 31);
    doc.text(`보고서 생성일시: ${timestamp}`, 40, infoY + 39);

    // Floor and Jeolju context
    const floorContext = selectedFloor || 'ALL';
    const jeoljuContext = selectedJeolju || '전체';
    doc.text(`현재 조회 범위: ${floorContext}층 / ${jeoljuContext}절주`, 40, infoY + 47);

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('Generated by P5 Live Grid Dashboard v2.3', centerX, pageHeight - 20, { align: 'center' });
    doc.text('PSRC/HMB 공법 기반 반도체 FAB 구조 관리 시스템', centerX, pageHeight - 14, { align: 'center' });
}

/**
 * Add Summary Dashboard Page to PDF
 * @param {Object} doc - jsPDF document
 * @param {number} margin - Page margin
 * @param {number} contentWidth - Content width
 * @param {Object} data - { columns, issues, statusCodes }
 */
function addPdfSummaryPage(doc, margin, contentWidth, data) {
    const { columns, issues, statusCodes } = data;
    const pageWidth = doc.internal.pageSize.getWidth();
    let yPos = 20;

    // Page header
    doc.setFillColor(31, 111, 235);
    doc.rect(0, 0, pageWidth, 15, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.text('요약 대시보드', margin, 10);

    yPos = 25;

    // Key Metrics Section
    doc.setTextColor(60, 60, 60);
    doc.setFontSize(11);
    doc.text('핵심 지표', margin, yPos);
    yPos += 8;

    // Calculate metrics
    const totalColumns = Object.keys(columns).length;
    const statusCounts = {};
    Object.values(columns).forEach(col => {
        const status = col.status || 'pending';
        statusCounts[status] = (statusCounts[status] || 0) + 1;
    });

    const completedCount = statusCounts['installed'] || 0;
    const activeCount = statusCounts['active'] || 0;
    const holdCount = (statusCounts['hold_tc'] || 0) + (statusCounts['hold_design'] || 0);
    const progressRate = totalColumns > 0 ? ((completedCount / totalColumns) * 100).toFixed(1) : 0;

    // Metrics table
    const metricsData = [
        ['전체 기둥', totalColumns.toLocaleString() + '개'],
        ['설치 완료', completedCount.toLocaleString() + '개 (' + progressRate + '%)'],
        ['진행중', activeCount.toLocaleString() + '개'],
        ['Hold (TC/설계)', holdCount.toLocaleString() + '개'],
        ['미해결 이슈', issues.filter(i => i.status !== 'resolved' && i.status !== 'closed').length + '건']
    ];

    doc.autoTable({
        startY: yPos,
        head: [['항목', '값']],
        body: metricsData,
        margin: { left: margin, right: margin },
        headStyles: { fillColor: [31, 111, 235], fontSize: 9 },
        bodyStyles: { fontSize: 9 },
        columnStyles: { 0: { cellWidth: 60 }, 1: { cellWidth: 60 } },
        tableWidth: 130
    });

    yPos = doc.lastAutoTable.finalY + 15;

    // Floor Progress Section
    doc.setTextColor(60, 60, 60);
    doc.setFontSize(11);
    doc.text('층별 진행률', margin, yPos);
    yPos += 8;

    const floorProgress = calculateFloorProgress(columns);
    const floorData = Object.entries(floorProgress).map(([floorId, data]) => [
        floorId,
        data.total.toString(),
        data.completed.toString(),
        data.active.toString(),
        data.hold.toString(),
        data.progress + '%'
    ]);

    doc.autoTable({
        startY: yPos,
        head: [['층', '전체', '완료', '진행중', 'Hold', '진행률']],
        body: floorData,
        margin: { left: margin, right: margin },
        headStyles: { fillColor: [31, 111, 235], fontSize: 8 },
        bodyStyles: { fontSize: 8 },
        alternateRowStyles: { fillColor: [248, 249, 250] },
        columnStyles: {
            0: { cellWidth: 20 },
            1: { cellWidth: 25, halign: 'right' },
            2: { cellWidth: 25, halign: 'right' },
            3: { cellWidth: 25, halign: 'right' },
            4: { cellWidth: 25, halign: 'right' },
            5: { cellWidth: 25, halign: 'right' }
        }
    });

    yPos = doc.lastAutoTable.finalY + 15;

    // Status Distribution Section
    doc.setTextColor(60, 60, 60);
    doc.setFontSize(11);
    doc.text('상태별 분포', margin, yPos);
    yPos += 8;

    const statusData = Object.entries(statusCodes).map(([code, info]) => {
        const count = statusCounts[code] || 0;
        const percent = totalColumns > 0 ? ((count / totalColumns) * 100).toFixed(1) : 0;
        return [info.label || code, count.toString(), percent + '%'];
    });

    doc.autoTable({
        startY: yPos,
        head: [['상태', '개수', '비율']],
        body: statusData,
        margin: { left: margin, right: margin },
        headStyles: { fillColor: [31, 111, 235], fontSize: 8 },
        bodyStyles: { fontSize: 8 },
        alternateRowStyles: { fillColor: [248, 249, 250] }
    });
}

/**
 * Add Detailed Floor Pages to PDF
 * @param {Object} doc - jsPDF document
 * @param {number} margin - Page margin
 * @param {number} contentWidth - Content width
 * @param {Object} data - { columns, issues, zones }
 */
function addPdfDetailedPages(doc, margin, contentWidth, data) {
    const { columns, issues, zones } = data;
    const floorIds = ['F01', 'F02', 'F03', 'F04', 'F05', 'F06', 'F07', 'F08', 'F09', 'F10', 'RF'];
    const pageWidth = doc.internal.pageSize.getWidth();

    floorIds.forEach(floorId => {
        doc.addPage();
        let yPos = 20;

        // Page header
        doc.setFillColor(31, 111, 235);
        doc.rect(0, 0, pageWidth, 15, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(12);
        doc.text(`${floorId} 층 상세 현황`, margin, 10);

        yPos = 25;

        // Get floor columns
        const floorColumns = Object.values(columns).filter(c =>
            c.floor === floorId || c.floorId === floorId
        );

        // Zone-based summary
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(10);
        doc.text('Zone별 현황', margin, yPos);
        yPos += 6;

        const zoneData = zones.map(zone => {
            const zoneCols = floorColumns.filter(c => c.zone?.id === zone.id || c.zoneId === zone.id);
            const completed = zoneCols.filter(c => c.status === 'installed').length;
            const active = zoneCols.filter(c => c.status === 'active').length;
            const hold = zoneCols.filter(c => c.status === 'hold_tc' || c.status === 'hold_design').length;
            const blocked = zoneCols.filter(c => c.status === 'hold_tc').length;

            return [
                zone.name || zone.id,
                zoneCols.length.toString(),
                completed.toString(),
                active.toString(),
                hold.toString(),
                blocked.toString()
            ];
        });

        doc.autoTable({
            startY: yPos,
            head: [['Zone', '전체', '완료', '진행중', '지연', '블록']],
            body: zoneData,
            margin: { left: margin, right: margin },
            headStyles: { fillColor: [31, 111, 235], fontSize: 8 },
            bodyStyles: { fontSize: 8 },
            alternateRowStyles: { fillColor: [248, 249, 250] }
        });

        yPos = doc.lastAutoTable.finalY + 12;

        // Stage-based progress
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(10);
        doc.text('공정(Stage)별 진행률', margin, yPos);
        yPos += 6;

        const stages = ['FA', 'SB', 'TC', 'TB', 'WD', 'CP'];
        const stageLabels = {
            'FA': '철골(FA)',
            'SB': '데크(SB)',
            'TC': 'T/C 설치(TC)',
            'TB': 'T/B 설치(TB)',
            'WD': '용접(WD)',
            'CP': '완료(CP)'
        };

        const stageData = stages.map(stage => {
            const stageComplete = floorColumns.filter(c => {
                const stageStatus = c.stages?.[stage];
                return stageStatus === 'complete' || stageStatus === 'installed';
            }).length;
            const progress = floorColumns.length > 0
                ? ((stageComplete / floorColumns.length) * 100).toFixed(1)
                : '0.0';
            return [stageLabels[stage] || stage, stageComplete.toString(), progress + '%'];
        });

        doc.autoTable({
            startY: yPos,
            head: [['공정', '완료', '진행률']],
            body: stageData,
            margin: { left: margin, right: margin },
            headStyles: { fillColor: [35, 134, 54], fontSize: 8 },
            bodyStyles: { fontSize: 8 },
            alternateRowStyles: { fillColor: [248, 249, 250] },
            tableWidth: 100
        });

        // Floor Issues Summary
        const floorIssues = issues.filter(issue =>
            issue.floorId === floorId || issue.floor === floorId
        );

        if (floorIssues.length > 0) {
            yPos = doc.lastAutoTable.finalY + 12;
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(10);
            doc.text(`이슈 현황 (${floorIssues.length}건)`, margin, yPos);
            yPos += 6;

            const issueData = floorIssues.slice(0, 10).map(issue => [
                issue.id?.slice(-6) || '-',
                getSeverityLabel(issue.severity),
                (issue.title || issue.description || '-').slice(0, 30),
                getIssueStatusLabel(issue.status)
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['ID', '심각도', '제목', '상태']],
                body: issueData,
                margin: { left: margin, right: margin },
                headStyles: { fillColor: [218, 54, 51], fontSize: 8 },
                bodyStyles: { fontSize: 7 },
                alternateRowStyles: { fillColor: [248, 249, 250] }
            });
        }
    });
}

/**
 * Add Issues Page to PDF
 * @param {Object} doc - jsPDF document
 * @param {number} margin - Page margin
 * @param {number} contentWidth - Content width
 * @param {Object} data - { issues }
 */
function addPdfIssuesPage(doc, margin, contentWidth, data) {
    const { issues } = data;
    const pageWidth = doc.internal.pageSize.getWidth();
    let yPos = 20;

    // Page header
    doc.setFillColor(218, 54, 51);
    doc.rect(0, 0, pageWidth, 15, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.text('이슈 요약', margin, 10);

    yPos = 25;

    // Issue statistics
    const openIssues = issues.filter(i => i.status === 'open');
    const inProgressIssues = issues.filter(i => i.status === 'in_progress');
    const resolvedIssues = issues.filter(i => i.status === 'resolved');
    const criticalIssues = issues.filter(i => i.severity === 'critical');
    const highIssues = issues.filter(i => i.severity === 'high');

    doc.setTextColor(60, 60, 60);
    doc.setFontSize(10);
    doc.text('이슈 통계', margin, yPos);
    yPos += 6;

    const statsData = [
        ['전체 이슈', issues.length.toString()],
        ['미해결 (Open)', openIssues.length.toString()],
        ['처리중 (In Progress)', inProgressIssues.length.toString()],
        ['해결됨 (Resolved)', resolvedIssues.length.toString()],
        ['Critical 등급', criticalIssues.length.toString()],
        ['High 등급', highIssues.length.toString()]
    ];

    doc.autoTable({
        startY: yPos,
        head: [['항목', '건수']],
        body: statsData,
        margin: { left: margin, right: margin },
        headStyles: { fillColor: [218, 54, 51], fontSize: 9 },
        bodyStyles: { fontSize: 9 },
        tableWidth: 100
    });

    yPos = doc.lastAutoTable.finalY + 15;

    // Severity distribution
    doc.setTextColor(60, 60, 60);
    doc.setFontSize(10);
    doc.text('심각도별 분포', margin, yPos);
    yPos += 6;

    const severityCounts = {};
    issues.forEach(issue => {
        const sev = issue.severity || 'low';
        severityCounts[sev] = (severityCounts[sev] || 0) + 1;
    });

    const severityData = [
        ['Critical (긴급)', (severityCounts['critical'] || 0).toString()],
        ['High (높음)', (severityCounts['high'] || 0).toString()],
        ['Medium (보통)', (severityCounts['medium'] || 0).toString()],
        ['Low (낮음)', (severityCounts['low'] || 0).toString()]
    ];

    doc.autoTable({
        startY: yPos,
        head: [['심각도', '건수']],
        body: severityData,
        margin: { left: margin, right: margin },
        headStyles: { fillColor: [210, 153, 34], fontSize: 9 },
        bodyStyles: { fontSize: 9 },
        tableWidth: 100
    });

    yPos = doc.lastAutoTable.finalY + 15;

    // Unresolved issues list
    const unresolvedIssues = issues.filter(i =>
        i.status !== 'resolved' && i.status !== 'closed'
    );

    if (unresolvedIssues.length > 0) {
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(10);
        doc.text(`미해결 이슈 목록 (${unresolvedIssues.length}건)`, margin, yPos);
        yPos += 6;

        const issueTableData = unresolvedIssues.slice(0, 20).map(issue => [
            issue.id?.slice(-8) || '-',
            issue.floorId || issue.floor || '-',
            getSeverityLabel(issue.severity),
            (issue.title || issue.description || '-').slice(0, 25),
            getIssueStatusLabel(issue.status),
            issue.createdAt ? new Date(issue.createdAt).toLocaleDateString('ko-KR') : '-'
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['ID', '층', '심각도', '제목', '상태', '생성일']],
            body: issueTableData,
            margin: { left: margin, right: margin },
            headStyles: { fillColor: [218, 54, 51], fontSize: 7 },
            bodyStyles: { fontSize: 7 },
            alternateRowStyles: { fillColor: [248, 249, 250] },
            columnStyles: {
                0: { cellWidth: 22 },
                1: { cellWidth: 15 },
                2: { cellWidth: 20 },
                3: { cellWidth: 50 },
                4: { cellWidth: 20 },
                5: { cellWidth: 25 }
            }
        });

        if (unresolvedIssues.length > 20) {
            const remaining = unresolvedIssues.length - 20;
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`... 외 ${remaining}건`, margin, doc.lastAutoTable.finalY + 8);
        }
    }
}

/**
 * Add page numbers to all pages
 * @param {Object} doc - jsPDF document
 */
function addPdfPageNumbers(doc) {
    const totalPages = doc.internal.getNumberOfPages();
    const pageHeight = doc.internal.pageSize.getHeight();
    const pageWidth = doc.internal.pageSize.getWidth();

    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);

        // Page number
        doc.text(`${i} / ${totalPages}`, pageWidth / 2, pageHeight - 8, { align: 'center' });

        // Footer line
        doc.setDrawColor(200, 200, 200);
        doc.line(15, pageHeight - 12, pageWidth - 15, pageHeight - 12);

        // Generation timestamp on first page footer
        if (i > 1) {
            doc.text('P5 Dashboard Report', 15, pageHeight - 8);
            doc.text(new Date().toLocaleDateString('ko-KR'), pageWidth - 15, pageHeight - 8, { align: 'right' });
        }
    }
}

/**
 * Generate complete PDF report
 * @param {string} type - Report type: 'summary' | 'detailed' | 'issues'
 * @param {Object} data - { columns, issues, zones, statusCodes, selectedFloor, selectedJeolju }
 * @returns {Object} { success, filename, error }
 */
function generatePdfReport(type, data) {
    try {
        if (typeof window.jspdf === 'undefined') {
            return { success: false, error: 'PDF 라이브러리가 로드되지 않았습니다.' };
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        const contentWidth = pageWidth - (margin * 2);

        // Generate timestamp
        const now = new Date();
        const timestamp = now.toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
        });
        const fileTimestamp = now.toISOString().replace(/[-:]/g, '').slice(0, 15);

        // Page 1: Cover Page
        addPdfCoverPage(doc, timestamp, type, data);

        // Page 2: Summary Dashboard
        doc.addPage();
        addPdfSummaryPage(doc, margin, contentWidth, data);

        // Detailed Report: Floor-by-Floor Pages
        if (type === 'detailed') {
            addPdfDetailedPages(doc, margin, contentWidth, data);
        }

        // Issues Report
        if (type === 'issues' || type === 'detailed') {
            doc.addPage();
            addPdfIssuesPage(doc, margin, contentWidth, data);
        }

        // Add page numbers to all pages
        addPdfPageNumbers(doc);

        // Generate filename and save
        const reportTypeLabel = {
            'summary': '요약',
            'detailed': '상세',
            'issues': '이슈'
        }[type] || '요약';

        const filename = `P5_구조관리_${reportTypeLabel}_보고서_${fileTimestamp}.pdf`;
        doc.save(filename);

        return { success: true, filename };

    } catch (error) {
        console.error('[PdfGenerator] Error:', error);
        return { success: false, error: error.message };
    }
}

// Export for testing (CommonJS)
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        calculateFloorProgress,
        getSeverityLabel,
        getIssueStatusLabel,
        addPdfCoverPage,
        addPdfSummaryPage,
        addPdfDetailedPages,
        addPdfIssuesPage,
        addPdfPageNumbers,
        generatePdfReport
    };
}

// WP-1-A: Expose to browser global for Alpine.js integration
if (typeof window !== 'undefined') {
    window.PdfGenerator = {
        calculateFloorProgress,
        getSeverityLabel,
        getIssueStatusLabel,
        generatePdfReport
    };
}
