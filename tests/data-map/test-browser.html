<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Map Browser Test</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #58a6ff; }
        h2 { color: #8b949e; border-bottom: 1px solid #30363d; padding-bottom: 10px; }

        .test-section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .pass { background: #238636; color: white; }
        .fail { background: #da3633; color: white; }
        .info { background: #1f6feb; color: white; }

        .drop-zone {
            border: 2px dashed #30363d;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .drop-zone:hover, .drop-zone.active {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.1);
        }

        .issues-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .issues-table th, .issues-table td {
            padding: 10px;
            border: 1px solid #30363d;
            text-align: left;
        }
        .issues-table th {
            background: #21262d;
        }

        .severity-critical { color: #f85149; }
        .severity-high { color: #d29922; }
        .severity-medium { color: #58a6ff; }
        .severity-low { color: #3fb950; }

        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover { background: #2ea043; }
        button.secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }
    </style>
</head>
<body x-data="testApp">
    <h1>üß™ Data Map Browser Test</h1>

    <!-- Test 1: Module Loading -->
    <div class="test-section">
        <h2>1. Module Loading Tests</h2>
        <div id="module-tests"></div>
        <button @click="runModuleTests()">Run Module Tests</button>
    </div>

    <!-- Test 2: File Upload -->
    <div class="test-section">
        <h2>2. File Upload Test</h2>
        <div class="drop-zone"
             :class="{ active: dragActive }"
             @dragover.prevent="dragActive = true"
             @dragleave="dragActive = false"
             @drop.prevent="handleDrop($event)">
            <p>üìÅ Drop Excel/CSV file here or click to select</p>
            <input type="file" @change="handleFileInput($event)"
                   accept=".xlsx,.xls,.csv" style="display: none" x-ref="fileInput">
            <button @click="$refs.fileInput.click()">Select File</button>
        </div>

        <div x-show="parsedIssues.length > 0" class="test-result info" style="margin-top: 15px;">
            ‚úÖ Parsed <span x-text="parsedIssues.length"></span> issues
        </div>

        <!-- Parsed Issues Table -->
        <template x-if="parsedIssues.length > 0">
            <table class="issues-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Floor</th>
                        <th>Zone</th>
                        <th>Columns</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="issue in parsedIssues" :key="issue.id">
                        <tr>
                            <td x-text="issue.issueType"></td>
                            <td x-text="issue.location?.floor || '-'"></td>
                            <td x-text="issue.location?.zone || '-'"></td>
                            <td x-text="(issue.location?.columns || []).slice(0,3).join(', ') + (issue.location?.columns?.length > 3 ? '...' : '')"></td>
                            <td :class="'severity-' + issue.severity?.toLowerCase()" x-text="issue.severity"></td>
                            <td x-text="issue.status"></td>
                            <td x-text="(issue.description || '').substring(0, 50) + '...'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </template>
    </div>

    <!-- Test 3: Parser Functions -->
    <div class="test-section">
        <h2>3. Parser Function Tests</h2>
        <div id="parser-tests"></div>
        <button @click="runParserTests()">Run Parser Tests</button>
    </div>

    <!-- Test 4: Store Tests -->
    <div class="test-section">
        <h2>4. Store Tests</h2>
        <div id="store-tests"></div>
        <button @click="runStoreTests()">Run Store Tests</button>
        <button class="secondary" @click="clearStore()">Clear Store</button>
    </div>

    <!-- Load actual modules -->
    <script src="../../src/dashboard/js/utils/unified-parser.js"></script>
    <script src="../../src/dashboard/js/utils/issue-matcher.js"></script>
    <script src="../../src/dashboard/js/stores/unified-store.js"></script>
    <script src="../../src/dashboard/js/components/data-map-view.js"></script>

    <script>
        function testApp() {
            return {
                dragActive: false,
                parsedIssues: [],

                // Handle file drop
                async handleDrop(event) {
                    this.dragActive = false;
                    const files = event.dataTransfer?.files;
                    if (files && files.length > 0) {
                        await this.parseFile(files[0]);
                    }
                },

                // Handle file input
                async handleFileInput(event) {
                    const files = event.target.files;
                    if (files && files.length > 0) {
                        await this.parseFile(files[0]);
                    }
                },

                // Parse file
                async parseFile(file) {
                    const output = document.getElementById('parser-tests');

                    if (!window.UnifiedParser) {
                        output.innerHTML = '<div class="test-result fail">‚ùå UnifiedParser not loaded</div>';
                        return;
                    }

                    try {
                        const result = await window.UnifiedParser.parse(file);
                        this.parsedIssues = result.issues || [];

                        if (this.parsedIssues.length > 0) {
                            // Add to store if available
                            const store = Alpine.store('unifiedData');
                            if (store && store.addIssues) {
                                store.addIssues(this.parsedIssues, 'test_upload');
                            }
                        }

                    } catch (error) {
                        console.error('Parse error:', error);
                        output.innerHTML = `<div class="test-result fail">‚ùå Parse error: ${error.message}</div>`;
                    }
                },

                // Run module loading tests
                runModuleTests() {
                    const output = document.getElementById('module-tests');
                    const results = [];

                    // Test UnifiedParser
                    const hasParser = typeof window.UnifiedParser !== 'undefined';
                    results.push({
                        name: 'UnifiedParser',
                        pass: hasParser,
                        detail: hasParser ? 'Loaded' : 'Not found'
                    });

                    // Test IssueMatcher
                    const hasMatcher = typeof window.IssueMatcher !== 'undefined';
                    results.push({
                        name: 'IssueMatcher',
                        pass: hasMatcher,
                        detail: hasMatcher ? 'Loaded' : 'Not found'
                    });

                    // Test Alpine Store
                    const hasStore = Alpine.store && typeof Alpine.store('unifiedData') !== 'undefined';
                    results.push({
                        name: 'UnifiedStore',
                        pass: hasStore,
                        detail: hasStore ? 'Initialized' : 'Not found'
                    });

                    // Test DataMapView
                    const hasView = typeof window.DataMapViewFactory !== 'undefined';
                    results.push({
                        name: 'DataMapView',
                        pass: hasView,
                        detail: hasView ? 'Registered' : 'Not found'
                    });

                    // Test XLSX library
                    const hasXLSX = typeof XLSX !== 'undefined';
                    results.push({
                        name: 'XLSX Library',
                        pass: hasXLSX,
                        detail: hasXLSX ? 'Loaded' : 'Not found'
                    });

                    output.innerHTML = results.map(r =>
                        `<div class="test-result ${r.pass ? 'pass' : 'fail'}">
                            ${r.pass ? '‚úÖ' : '‚ùå'} ${r.name}: ${r.detail}
                        </div>`
                    ).join('');
                },

                // Run parser function tests
                runParserTests() {
                    const output = document.getElementById('parser-tests');
                    const results = [];

                    if (!window.UnifiedParser) {
                        output.innerHTML = '<div class="test-result fail">‚ùå UnifiedParser not loaded</div>';
                        return;
                    }

                    // Test detectFormat
                    const formatTests = [
                        { file: { name: 'test.xlsx' }, expected: 'excel' },
                        { file: { name: 'test.csv' }, expected: 'csv' },
                        { file: { name: 'test.png', type: 'image/png' }, expected: 'image' }
                    ];

                    for (const test of formatTests) {
                        const result = UnifiedParser.detectFormat(test.file);
                        results.push({
                            name: `detectFormat(${test.file.name})`,
                            pass: result === test.expected,
                            detail: `${result} (expected: ${test.expected})`
                        });
                    }

                    // Test extractLocation
                    const locTest = UnifiedParser.extractLocation('3F Zone A, A-X15~20');
                    results.push({
                        name: 'extractLocation()',
                        pass: locTest && locTest.floor === '3F' && locTest.zone === 'A',
                        detail: `floor:${locTest?.floor}, zone:${locTest?.zone}, cols:${locTest?.columns?.length || 0}`
                    });

                    // Test extractIssueType
                    const typeTest = UnifiedParser.extractIssueType('PSRC Î∂ÄÏû¨ Í∞ÑÏÑ≠');
                    results.push({
                        name: 'extractIssueType()',
                        pass: typeTest === 'PSRC',
                        detail: typeTest
                    });

                    output.innerHTML = results.map(r =>
                        `<div class="test-result ${r.pass ? 'pass' : 'fail'}">
                            ${r.pass ? '‚úÖ' : '‚ùå'} ${r.name}: ${r.detail}
                        </div>`
                    ).join('');
                },

                // Run store tests
                runStoreTests() {
                    const output = document.getElementById('store-tests');
                    const results = [];

                    const store = Alpine.store('unifiedData');

                    if (!store) {
                        output.innerHTML = '<div class="test-result fail">‚ùå UnifiedStore not found</div>';
                        return;
                    }

                    // Test store existence
                    results.push({
                        name: 'Store exists',
                        pass: true,
                        detail: 'Alpine.store("unifiedData") found'
                    });

                    // Test addIssues
                    const hasAddIssues = typeof store.addIssues === 'function';
                    results.push({
                        name: 'addIssues()',
                        pass: hasAddIssues,
                        detail: hasAddIssues ? 'Available' : 'Not found'
                    });

                    // Test current issue count
                    const issueCount = store.issues?.length || 0;
                    results.push({
                        name: 'Issue count',
                        pass: true,
                        detail: `${issueCount} issues in store`
                    });

                    // Test findByLocation
                    const hasFindByLocation = typeof store.findByLocation === 'function';
                    results.push({
                        name: 'findByLocation()',
                        pass: hasFindByLocation,
                        detail: hasFindByLocation ? 'Available' : 'Not found'
                    });

                    // Test updateClusters
                    const hasUpdateClusters = typeof store.updateClusters === 'function';
                    results.push({
                        name: 'updateClusters()',
                        pass: hasUpdateClusters,
                        detail: hasUpdateClusters ? 'Available' : 'Not found'
                    });

                    // Test cluster count
                    const clusterCount = store.clusters?.length || 0;
                    results.push({
                        name: 'Cluster count',
                        pass: true,
                        detail: `${clusterCount} clusters`
                    });

                    output.innerHTML = results.map(r =>
                        `<div class="test-result ${r.pass ? 'pass' : 'fail'}">
                            ${r.pass ? '‚úÖ' : '‚ùå'} ${r.name}: ${r.detail}
                        </div>`
                    ).join('');
                },

                // Clear store
                clearStore() {
                    const store = Alpine.store('unifiedData');
                    if (store && store.clearAll) {
                        store.clearAll();
                        this.parsedIssues = [];
                        this.runStoreTests();
                    }
                }
            };
        }
    </script>
</body>
</html>
