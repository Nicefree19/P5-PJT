name: PR Check

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production

      - name: Analyze Bundle Size
        id: bundle
        run: |
          echo "## ðŸ“¦ Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate sizes
          TOTAL_SIZE=$(du -sb dist/ | cut -f1)
          TOTAL_SIZE_KB=$((TOTAL_SIZE / 1024))

          HTML_SIZE=$(stat -f%z dist/index.html 2>/dev/null || stat -c%s dist/index.html)
          HTML_SIZE_KB=$((HTML_SIZE / 1024))

          # Check for compressed files
          if [ -f dist/index.html.br ]; then
            BR_SIZE=$(stat -f%z dist/index.html.br 2>/dev/null || stat -c%s dist/index.html.br)
            BR_SIZE_KB=$((BR_SIZE / 1024))
          else
            BR_SIZE_KB=0
          fi

          if [ -f dist/index.html.gz ]; then
            GZ_SIZE=$(stat -f%z dist/index.html.gz 2>/dev/null || stat -c%s dist/index.html.gz)
            GZ_SIZE_KB=$((GZ_SIZE / 1024))
          else
            GZ_SIZE_KB=0
          fi

          # Output to summary
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total (dist/) | ${TOTAL_SIZE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          echo "| index.html | ${HTML_SIZE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          if [ $BR_SIZE_KB -gt 0 ]; then
            echo "| index.html.br (Brotli) | ${BR_SIZE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ $GZ_SIZE_KB -gt 0 ]; then
            echo "| index.html.gz (Gzip) | ${GZ_SIZE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          fi

          # Set outputs for PR comment
          echo "total_kb=${TOTAL_SIZE_KB}" >> $GITHUB_OUTPUT
          echo "html_kb=${HTML_SIZE_KB}" >> $GITHUB_OUTPUT
          echo "br_kb=${BR_SIZE_KB}" >> $GITHUB_OUTPUT

      - name: Comment Bundle Size on PR
        uses: actions/github-script@v7
        with:
          script: |
            const total = '${{ steps.bundle.outputs.total_kb }}';
            const html = '${{ steps.bundle.outputs.html_kb }}';
            const br = '${{ steps.bundle.outputs.br_kb }}';

            const body = `## ðŸ“¦ Bundle Size Report

            | Metric | Size |
            |--------|------|
            | **Total (dist/)** | ${total} KB |
            | **index.html** | ${html} KB |
            | **Brotli compressed** | ${br} KB |

            <details>
            <summary>ðŸ“Š Size Guidelines</summary>

            - âœ… Brotli < 100 KB: Excellent
            - âš ï¸ Brotli 100-150 KB: Acceptable
            - âŒ Brotli > 150 KB: Needs optimization

            </details>

            ---
            ðŸ¤– *Generated by GitHub Actions*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Bundle Size Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  unit-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Run Unit Tests
        run: npm test -- --coverage --passWithNoTests
        continue-on-error: true

      - name: Test Summary
        run: |
          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Unit tests executed. Check logs for details." >> $GITHUB_STEP_SUMMARY
